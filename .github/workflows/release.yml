name: Create Release & Deploy

on:
  push:
    tags:
      - 'v*'

env:
  JAVA_VERSION: '17'

jobs:
  build-release:
    name: Build Release APK
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: ðŸ”§ Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ðŸ—ï¸ Build Release APK
        run: ./gradlew assembleRelease --stacktrace

      - name: ðŸ“ Get Version from Tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: ðŸ“‹ Generate Changelog
        id: changelog
        run: |
          CHANGELOG=$(git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --oneline | head -20)
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: app/build/outputs/apk/release/app-release.apk
          tag_name: ${{ steps.version.outputs.VERSION }}
          body: |
            ## Android Modem App - Release ${{ steps.version.outputs.VERSION }}

            ### Changelog
            ```
            ${{ steps.changelog.outputs.CHANGELOG }}
            ```

            ### Installation Guide
            1. Download `app-release.apk` from the Assets below
            2. Enable "Unknown Sources" in Android Settings
            3. Install the APK
            4. Grant required permissions
            5. Start the service and access WebUI

            ### Requirements
            - Android 7.0+ (API 24+)
            - Root access (recommended for full functionality)
            - 50MB free storage

            ### Support
            For issues, please visit: [GitHub Issues](https://github.com/koryok083/android-modem-app/issues)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¤ Upload Release Assets
        uses: actions/upload-artifact@v3
        with:
          name: release-apk
          path: app/build/outputs/apk/release/app-release.apk
          retention-days: 90

      - name: ðŸ“¢ Discord Notification
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          title: "ðŸš€ Android Modem App Released - ${{ steps.version.outputs.VERSION }}"
          description: "Download from GitHub Releases"
          url: ${{ github.server_url }}/${{ github.repository }}/releases
