name: Android CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

env:
  GRADLE_USER_HOME: ${{ github.workspace }}/.gradle
  JAVA_VERSION: '17'
  ANDROID_SDK_VERSION: '33'

jobs:
  # ==================== BUILD JOB ====================
  build:
    name: Build APK
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ”§ Install Gradle
        run: |
          sudo apt-get update
          sudo apt-get install -y gradle

      - name: ğŸ“Š Display Java Version
        run: java -version

      - name: ğŸ—ï¸ Build Debug APK
        run: ./gradlew assembleDebug --stacktrace --info
        timeout-minutes: 30

      - name: ğŸ“¤ Upload Debug APK Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      - name: ğŸ“Š Upload Build Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-reports
          path: |
            app/build/reports/
            build/
          retention-days: 7

  # ==================== TEST JOB ====================
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: build

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ”§ Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ğŸ§ª Run Unit Tests
        run: ./gradlew testDebugUnitTest --stacktrace
        continue-on-error: true

      - name: ğŸ“¤ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: app/build/reports/tests/testDebugUnitTest/

  # ==================== LINT JOB ====================
  lint:
    name: Lint Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ”§ Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ğŸ” Run Lint
        run: ./gradlew lint --stacktrace
        continue-on-error: true

      - name: ğŸ“¤ Upload Lint Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: app/build/reports/lint-results*.html

  # ==================== CODE QUALITY JOB ====================
  quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Java JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: ğŸ”§ Grant Execute Permission
        run: chmod +x ./gradlew

      - name: ğŸ“Š Analyze with SonarQube
        run: ./gradlew sonarqube --stacktrace
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  # ==================== STATUS JOB ====================
  status:
    name: Build Status
    runs-on: ubuntu-latest
    needs: [build, test, lint]
    if: always()

    steps:
      - name: âœ… Build Successful
        if: success()
        run: |
          echo "âœ… All jobs completed successfully!"
          echo "ğŸ“¦ Artifacts are ready for download"

      - name: âš ï¸ Build Completed with Warnings
        if: failure()
        run: |
          echo "âš ï¸ Some jobs failed. Check the logs above."
          exit 1

      - name: ğŸ“¢ Slack Notification
        if: always()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Android Modem App Build Status",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Android Modem App CI/CD*\n*Status*: ${{ job.status }}\n*Branch*: ${{ github.ref }}\n*Commit*: ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
